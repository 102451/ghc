#!/bin/sh

# Manuel M. T. Chakravarty <chak@acm.org>, June 2000
#
# Script to build GHC from .hc files (must be run in the fptools/ root
# directory into which the source and .hc files must already have been
# unpacked).  All options are passed through to ./configure (especially
# useful with --prefix).

configopts="$*"

# check for GNU make
#
MAKENAMES="gmake make no-make"
for make in $MAKENAMES; do
  MAKE=$make
  $make --version 2>&1 | grep "GNU Make" >/dev/null && break
done
if [ $MAKE = no-make ]; then
  echo "Fatal error: Cannot find the GNU make utility"
  exit 1
fi

# build configuration
#
cat >mk/build.mk <<END
ProjectsToBuild = glafp-utils hslibs ghc
GhcLibHcOpts = -O
SRC_HAPPY_OPTS += -c
GhcLibWays=
END

# touch happy generated files; so that in non-bootstrapping mode for
# installation, no attempt is made to call happy
#
touch ghc/compiler/rename/ParseIface.hs
touch ghc/compiler/parser/Parser.hs

echo "*** Building hsc..."
./configure --enable-hc-boot $configopts        || exit 1
$MAKE boot all                                  || exit 1

echo "*** Building library..."
echo "GhcWithHscBuiltViaC=NO" >>mk/build.mk
$MAKE -C ghc/lib clean boot all			|| exit 1
$MAKE -C hslibs  clean boot all
